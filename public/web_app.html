<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ThriftAssist - AI Media Finder</title>
    <!-- Panzoom library for image zoom/pan -->
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;  /* Root font size - never changes */
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
            height: 100%;
            overflow-x: hidden;  /* Prevent horizontal scroll at root */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;  /* Keep background fixed on scroll */
            min-height: 100vh;
            font-size: inherit;  /* Inherit from html - stays 16px */
            width: 100%;
            max-width: 100vw;  /* Prevent body from exceeding viewport */
            overflow-x: hidden;  /* Prevent horizontal scroll */
            margin: 0;
            padding: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            font-size: 16px;  /* Default size - stays constant */
            box-sizing: border-box;  /* Include padding in width calculation */
        }
        
        /* Text scaling wrapper - only scales text content, not layout */
        .text-content {
            font-size: 1em;  /* Inherits from text-scale class */
            max-width: 100%;
            overflow-x: hidden;
            word-wrap: break-word;  /* Prevent long words from overflowing */
        }
        
        /* Text scaling via text-content wrapper only - doesn't affect layout */
        body.text-scale-50 .text-content { font-size: 0.5em; }
        body.text-scale-75 .text-content { font-size: 0.75em; }
        body.text-scale-100 .text-content { font-size: 1em; }
        body.text-scale-125 .text-content { font-size: 1.25em; }
        body.text-scale-150 .text-content { font-size: 1.5em; }
        body.text-scale-175 .text-content { font-size: 1.75em; }
        body.text-scale-200 .text-content { font-size: 2em; }
        body.text-scale-250 .text-content { font-size: 2.5em; }
        body.text-scale-300 .text-content { font-size: 3em; }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 0.625em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;  /* Always single column */
            gap: 30px;
            align-items: start;
            width: 100%;
            max-width: 100%;  /* Let the container control max-width */
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Remove desktop-text-large responsive layout - always stacked */
        .header {
            max-width: 100%;  /* Match main-content width */
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Ensure container keeps padding */
        .container {
            padding-left: 20px;
            padding-right: 20px;
        }
        
        /* Ensure cards center properly */
        .card {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* Fix image container centering */
        .image-container {
            margin-left: 0 !important;
            margin-right: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        /* Ensure image itself is centered */
        .image-preview {
            margin-left: 0 !important;
            margin-right: 0 !important;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 1.5625em;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;  /* Prevent horizontal overflow */
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #5a67d8;
            margin-bottom: 1.25em;
            font-size: 1.5em;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.625em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5em;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.875em;
        }

        .form-group input[type="file"],
        .form-group input[type="number"],
        .form-group input[type="range"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            max-width: 100%;
            padding: 0.75em;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input[type="range"] {
            padding: 0;
            height: 8px;
            background: #e2e8f0;
            outline: none;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            width: 100%;
        }

        .form-group input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #5a67d8;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .form-group input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #5a67d8;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .form-group input[type="range"]::-webkit-slider-thumb {
                width: 28px;
                height: 28px;
            }
            
            .form-group input[type="range"]::-moz-range-thumb {
                width: 28px;
                height: 28px;
            }
            
            .btn {
                padding: 14px 24px;
                min-height: 48px;  /* Better touch target */
            }
            
            .collapsible-header {
                min-height: 44px;  /* Better touch target */
            }
        }

        .slider-container {
            width: 100%;
            margin-top: 5px;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .slider-value {
            font-weight: 600;
            color: #5a67d8;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.9375em 1.875em;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;  /* Explicitly set same font as body */
            transition: all 0.3s ease;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Collapsible sections styling */
        .collapsible {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-top: 10px;
            overflow: hidden;
        }

        .collapsible-header {
            padding: 0.75em 0.9375em;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            color: #4a5568;
            background: #f7fafc;
            transition: background-color 0.2s ease;
        }

        .collapsible-header:hover {
            background: #edf2f7;
        }

        .collapsible-icon {
            transition: transform 0.2s ease;
            color: #666;
        }

        .collapsible.open .collapsible-icon {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding: 0 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .collapsible.open .collapsible-content {
            max-height: 31.25em;  /* 500px at default */
            padding: 0.9375em;
        }

        .help-text {
            font-size: 0.9em;  /* Proportional to body */
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #5a67d8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
        }

        .results-summary {
            background: #f7fafc;
            border-radius: 8px;
            padding: 0.9375em;
            margin-bottom: 1.25em;
            border-left: 4px solid #48bb78;
        }

        .results-summary h3 {
            color: #2d3748;
            margin-bottom: 10px;
        }

        .stat {
            display: inline-block;
            margin-right: 20px;
            font-weight: 600;
        }

        .matches-list {
            margin-top: 20px;
        }

        .match-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 0.75em;
            margin-bottom: 0.625em;
            border-left: 3px solid #5a67d8;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        .match-phrase {
            font-weight: 600;
            color: #5a67d8;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .match-details {
            font-size: 0.9em;
            color: #666;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.75em;
            margin-bottom: 0.625em;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }
        
        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
            gap: 10px;
        }
        
        .match-text-preview {
            font-size: 0.85em;
            color: #718096;
            font-style: italic;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .match-scores {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .match-score {
            background: #e6fffa;
            color: #234e52;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .match-count {
            background: #5a67d8;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 0.625em;
        }

        .toggle-details {
            font-size: 0.8em;
            color: #5a67d8;
            cursor: pointer;
            margin-left: 0.625em;
            text-decoration: underline;
        }

        .toggle-details:hover {
            color: #4c51bf;
        }

        .image-preview {
            max-width: 100%;
            width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-top: 15px;
            cursor: zoom-in;
            transition: transform 0.3s ease;
            display: block;
            object-fit: contain;  /* Maintain aspect ratio */
        }

        /* Zoom functionality styles */
        .image-container {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            margin-top: 15px;
            background: #f8f9fa;
            display: block;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            touch-action: none;  /* Disable browser touch gestures */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .image-preview.zoomable {
            cursor: zoom-in;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            display: block;
            transform-origin: 0 0;
            transition: none;
            width: 100%;
            height: auto;
            max-width: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            -webkit-font-smoothing: subpixel-antialiased;
        }

        .image-preview.zoomed {
            cursor: grab;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            -webkit-font-smoothing: subpixel-antialiased;
        }

        .image-preview.zoomed:active {
            cursor: grabbing;
        }

        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 8px;
            display: none;
            z-index: 1000;
            flex-direction: row;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .zoom-controls.visible {
            display: flex;
        }

        .zoom-btn {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .zoom-btn svg {
            display: block;
        }

        .zoom-btn:hover {
            background: white;
            transform: scale(1.05);
        }

        .zoom-btn:active {
            transform: scale(0.95);
            background: #f0f0f0;
        }
        
        /* Touch device zoom controls */
        @media (hover: none) and (pointer: coarse) {
            .zoom-controls {
                bottom: 80px;
                right: 15px;
                padding: 6px;
                gap: 6px;
            }
            
            .zoom-btn {
                width: 48px;
                height: 48px;
                font-size: 22px;
            }
        }

        .zoom-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            color: white;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .zoom-info.visible {
            display: block;
        }

        .explanation-panel {
            background: #f8f9ff;
            border-left: 4px solid #5a67d8;
            padding: 0.75em;
            margin-top: 0.625em;
            border-radius: 4px;
            font-size: 0.85em;
        }
        
        .confidence-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .confidence-very-high {
            background: #d4edda;
            color: #155724;
        }
        
        .confidence-high {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .confidence-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .confidence-low {
            background: #f8d7da;
            color: #721c24;
        }
        
        .factor-list {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .factor-item {
            margin: 4px 0;
            color: #555;
        }
        
        .warning-badge {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            padding: 6px 10px;
            margin: 6px 0;
            border-radius: 3px;
            font-size: 0.8em;
            color: #856404;
        }
        
        .toggle-explanation {
            color: #5a67d8;
            cursor: pointer;
            font-size: 0.85em;
            text-decoration: underline;
            user-select: none;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .toggle-explanation:hover {
            color: #4c51bf;
            text-decoration: none;
        }
        
        .toggle-explanation:active {
            transform: scale(0.95);
        }
        
        /* Global text scaling - proportional sizing */
        body.text-scale-small {
            font-size: 14px;
        }
        
        body.text-scale-medium {
            font-size: 16px;
        }
        
        body.text-scale-large {
            font-size: 18px;
        }
        
        body.text-scale-xlarge {
            font-size: 20px;
        }
        
        /* Proportional element scaling based on text size */
        .form-group input[type="file"],
        .form-group input[type="number"],
        .form-group textarea,
        .form-group select {
            font-size: 1em;  /* Scale with body font */
            padding: 0.75em;  /* Proportional padding */
        }
        
        .btn {
            font-size: 1em;  /* Scale with body font */
            padding: 0.9375em 1.875em;  /* Proportional padding (15px/16px, 30px/16px) */
        }
        
        .form-group label {
            font-size: 0.875em;  /* 14px at default */
            margin-bottom: 0.5em;
        }
        
        .card {
            padding: 1.5625em;  /* 25px at default */
        }
        
        .card h2 {
            font-size: 1.5em;  /* Proportional to body */
            margin-bottom: 1.25em;
            padding-bottom: 0.625em;
        }
        
        .header h1 {
            font-size: 2.5em;  /* Proportional to body */
            margin-bottom: 0.625em;
        }

        .header p {
            font-size: 1.2em;  /* Proportional to body */
        }

        .collapsible-header {
            font-size: 0.9em;  /* Proportional to body */
            padding: 0.75em 0.9375em;  /* Proportional padding */
        }

        .collapsible.open .collapsible-content {
            max-height: 31.25em;  /* 500px at default */
            padding: 0.9375em;
        }

        .help-text {
            font-size: 0.9em;  /* Proportional to body */
        }

        .match-item {
            padding: 0.75em;
            margin-bottom: 0.625em;
        }

        .match-details {
            padding: 0.75em;
            margin-bottom: 0.625em;
        }

        .results-summary {
            padding: 0.9375em;
            margin-bottom: 1.25em;
        }

        .explanation-panel {
            padding: 0.75em;
            margin-top: 0.625em;
        }

        /* ===== RESPONSIVE MEDIA QUERIES ===== */
        
        /* Tablet devices (768px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 100%;
                padding: 20px;
            }
            
            .main-content {
                max-width: 100%;
            }
            
            .card {
                padding: 20px;
            }
        }
        
        /* Tablet landscape mode */
        @media (min-width: 769px) and (max-width: 1024px) and (orientation: landscape) {
            .container {
                padding: 15px 30px;
            }
            
            .main-content {
                gap: 25px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
        }
        
        /* Mobile devices (up to 768px) */
        @media (max-width: 768px) {
            body {
                font-size: 16px;
                width: 100vw;
                max-width: 100vw;
                overflow-x: hidden;
            }
            
            .container {
                font-size: 16px;
                padding: 15px;
                max-width: 100vw;
                width: 100%;
                overflow-x: hidden;
                margin-left: 0;
                margin-right: 0;
                box-sizing: border-box;
            }
            
            .text-content {
                font-size: 1.125em;
                max-width: 100%;
                overflow-x: hidden;
            }
            
            body.text-scale-50 .text-content { font-size: 0.5625em; }
            body.text-scale-75 .text-content { font-size: 0.84375em; }
            body.text-scale-100 .text-content { font-size: 1.125em; }
            body.text-scale-125 .text-content { font-size: 1.40625em; }
            body.text-scale-150 .text-content { font-size: 1.6875em; }
            body.text-scale-175 .text-content { font-size: 1.96875em; }
            body.text-scale-200 .text-content { font-size: 2.25em; }
            body.text-scale-250 .text-content { font-size: 2.8125em; }
            body.text-scale-300 .text-content { font-size: 3.375em; }
            
            .main-content {
                max-width: 100%;
                width: 100%;
                gap: 20px;
            }
            
            .header {
                max-width: 100%;
                width: 100%;
                margin-bottom: 20px;
            }
            
            .card {
                width: 100%;
                max-width: 100%;
                padding: 20px;
            }

            .image-preview {
                margin-left: 0 !important;
                margin-right: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }
            
            .image-container {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            /* Stack form controls vertically on mobile */
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px;  /* Prevent zoom on iOS */
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 16px;
            }
        }
        
        /* Mobile landscape mode */
        @media (max-width: 768px) and (orientation: landscape) {
            .container {
                padding: 10px 20px;
            }
            
            .main-content {
                gap: 15px;
            }
            
            .card {
                padding: 15px;
            }
            
            .header {
                margin-bottom: 15px;
            }
            
            .header h1 {
                font-size: 2em;
                margin-bottom: 0.3em;
            }
            
            .header p {
                font-size: 1em;
            }
            
            /* Reduce collapsible content height in landscape */
            .collapsible.open .collapsible-content {
                max-height: 20em;
            }
        }

        /* Small mobile devices (up to 480px) */
        @media (max-width: 480px) {
            body {
                font-size: 16px;
                width: 100vw;
                overflow-x: hidden;
            }
            
            .container {
                padding: 10px;
                font-size: 16px;
                max-width: 100vw;
                width: 100%;
                margin-left: 0;
                margin-right: 0;
            }

            .card {
                padding: 15px;
                width: 100%;
            }

            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 0.95em;
            }
            
            .slider-labels {
                font-size: 0.75em;
            }
            
            /* Adjust match item layout for small screens */
            .match-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .match-scores {
                width: 100%;
                justify-content: flex-start;
            }
        }
        
        /* Small mobile landscape */
        @media (max-width: 480px) and (orientation: landscape) {
            .container {
                padding: 8px 15px;
            }
            
            .card {
                padding: 12px;
            }
            
            .header h1 {
                font-size: 1.5em;
                margin-bottom: 0.2em;
            }
            
            .header p {
                font-size: 0.9em;
            }
            
            .main-content {
                gap: 12px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            .btn {
                padding: 10px 16px;
            }
        }
        
        /* Large desktop screens */
        @media (min-width: 1400px) {
            .container {
                max-width: 1400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-content">
            <div class="header">
                <h1>🔍 ThriftAssist</h1>
                <p>AI-powered media finder for thrift stores</p>
            </div>

            <div class="main-content">
                <!-- Input Form -->
                <div class="card">
                    <h2>📤 Upload & Search</h2>
                    <form id="ocrForm">
                        <div class="form-group">
                            <label for="imageFile">Select Image</label>
                            <input type="file" id="imageFile" accept="image/*" required>
                            <div class="collapsible">
                                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                    <span>📝 Supported formats & tips</span>
                                    <span class="collapsible-icon">▼</span>
                                </div>
                                <div class="collapsible-content">
                                    <div class="help-text">
                                        <strong>Supported formats:</strong> JPG, PNG, GIF, BMP<br><br>
                                        <strong>Tips for best results:</strong><br>
                                        • Ensure text is clearly visible<br>
                                        • Good lighting improves accuracy<br>
                                        • Higher resolution images work better<br>
                                        • Multiple angles of text are supported
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="searchPhrases">Search Phrases</label>
                            <textarea id="searchPhrases" placeholder="Enter phrases separated by commas" required></textarea>
                            <div class="collapsible">
                                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                    <span>💡 Search tips & examples</span>
                                    <span class="collapsible-icon">▼</span>
                                </div>
                                <div class="collapsible-content">
                                    <div class="help-text">
                                        <strong>Examples:</strong><br>
                                        • Books: <em>Homecoming, Lee Child, Circle of Three</em><br>
                                        • Music: <em>Billy Joel, U2, Greatest Hits</em><br>
                                        • Movies: <em>Star Wars, Marvel, Disney</em><br><br>
                                        <strong>Tips:</strong><br>
                                        • Use specific titles or author names<br>
                                        • Separate multiple phrases with commas<br>
                                        • Both exact and partial matches are found<br>
                                        • Case doesn't matter
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="threshold">Detection Threshold: <span id="thresholdValue" class="slider-value">80%</span></label>
                            <div class="slider-container">
                                <input type="range" id="threshold" min="50" max="100" value="80" step="5">
                                <div class="slider-labels">
                                    <span>Lenient</span>
                                    <span>Strict</span>
                                </div>
                            </div>
                            <div class="collapsible">
                                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                    <span>⚙️ Threshold guide</span>
                                    <span class="collapsible-icon">▼</span>
                                </div>
                                <div class="collapsible-content">
                                    <div class="help-text">
                                        <strong>50-60%:</strong> Very lenient - finds partial matches but may include false positives<br>
                                        <strong>70-80%:</strong> Balanced - recommended for most images<br>
                                        <strong>85-95%:</strong> Strict - high confidence matches only<br>
                                        <strong>95-100%:</strong> Very strict - only near-exact matches<br><br>
                                        Start with 80% and adjust based on results.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center;">
                                <div>
                                    <label for="uiTextScale" style="text-align: center; line-height: 1.2;">
                                        <div>Page</div>
                                        <div>Font Size</div>
                                    </label>
                                    <select id="uiTextScale" style="width: 100%; padding: 0.75em; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1.125em; cursor: pointer; text-align: center; text-align-last: center;">
                                        <option value="50">50%</option>
                                        <option value="75">75%</option>
                                        <option value="100" selected>100%</option>
                                        <option value="125">125%</option>
                                        <option value="150">150%</option>
                                        <option value="175">175%</option>
                                        <option value="200">200%</option>
                                        <option value="250">250%</option>
                                        <option value="300">300%</option>
                                    </select>
                                </div>
                                <div style="position: relative; display: flex; align-items: center; padding: 0 10px;">
                                    <div style="position: absolute; left: -10px; right: 50%; height: 2px; background: #e2e8f0; top: 50%;"></div>
                                    <div style="position: absolute; left: 50%; right: -10px; height: 2px; background: #e2e8f0; top: 50%;"></div>
                                    <button type="button" id="syncTextScales" title="Sync font sizes" style="position: relative; z-index: 1; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; font-size: 16px; transition: all 0.2s;">
                                        🔗
                                    </button>
                                </div>
                                <div>
                                    <label for="textScale" style="text-align: center; line-height: 1.2;">
                                        <div>Annotation</div>
                                        <div>Font Size</div>
                                    </label>
                                    <select id="textScale" style="width: 100%; padding: 0.75em; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1.125em; cursor: pointer; text-align: center; text-align-last: center;">
                                        <option value="50">50%</option>
                                        <option value="75">75%</option>
                                        <option value="100" selected>100%</option>
                                        <option value="125">125%</option>
                                        <option value="150">150%</option>
                                        <option value="175">175%</option>
                                        <option value="200">200%</option>
                                        <option value="250">250%</option>
                                        <option value="300">300%</option>
                                    </select>
                                </div>
                            </div>
                            <div style="font-size: 0.85em; color: #666; margin-top: 8px;">
                                Page font adjusts this interface, annotation font adjusts text on images. Click 🔗 to sync both.
                            </div>
                        </div>

                        <button type="submit" class="btn" id="submitBtn">
                            🚀 Analyze Image
                        </button>
                    </form>

                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p>Processing image and detecting phrases...</p>
                    </div>
                </div>

                <!-- Results -->
                <div class="card">
                    <h2>📊 Results</h2>
                    
                    <div id="noResults">
                        <p style="text-align: center; color: #666; padding: 40px 0;">
                            👆 Upload an image and search for phrases to see results here
                        </p>
                    </div>

                    <div class="results" id="results">
                        <div class="results-summary" id="resultsSummary">
                            <!-- Results summary will be populated here -->
                        </div>

                        <div class="matches-list" id="matchesList">
                            <!-- Matches will be populated here -->
                        </div>

                        <div>
                            <h3 style="margin: 20px 0 10px 0;">📸 Annotated Image</h3>
                            <div class="image-container" id="imageContainer">
                                <img id="annotatedImage" class="image-preview zoomable" alt="Annotated result">
                                <div class="zoom-controls" id="zoomControls">
                                    <button class="zoom-btn" id="zoomOutBtn" title="Zoom Out">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round">
                                            <circle cx="11" cy="11" r="8"></circle>
                                            <line x1="7" y1="11" x2="15" y2="11"></line>
                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                        </svg>
                                    </button>
                                    <button class="zoom-btn" id="resetZoomBtn" title="Fit to Screen">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="15 3 21 3 21 9"></polyline>
                                            <polyline points="9 21 3 21 3 15"></polyline>
                                            <line x1="21" y1="3" x2="14" y2="10"></line>
                                            <line x1="3" y1="21" x2="10" y2="14"></line>
                                        </svg>
                                    </button>
                                    <button class="zoom-btn" id="zoomInBtn" title="Zoom In">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round">
                                            <circle cx="11" cy="11" r="8"></circle>
                                            <line x1="11" y1="7" x2="11" y2="15"></line>
                                            <line x1="7" y1="11" x2="15" y2="11"></line>
                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                        </svg>
                                    </button>
                                </div>
                                <div class="zoom-info" id="zoomInfo">100%</div>
                            </div>
                        </div>
                    </div>

                    <div class="error" id="error" style="display: none;">
                        <!-- Error messages will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Device detection
        const DeviceDetector = {
            isMobile: false,
            isTablet: false,
            isDesktop: false,
            isTouchDevice: false,
            userAgent: '',
            
            init() {
                this.updateDeviceInfo();
                this.updateBodyClasses();
                this.logDeviceInfo();
                
                // Listen for orientation changes
                window.addEventListener('orientationchange', () => {
                    console.log('🔄 Orientation change event fired');
                    // Small delay to let viewport settle
                    setTimeout(() => {
                        this.handleOrientationChange();
                    }, 100);
                    // Also check after a longer delay in case of slow viewport update
                    setTimeout(() => {
                        this.handleOrientationChange();
                    }, 500);
                });
                
                // Listen for resize events (catches orientation changes too)
                let resizeTimer;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => {
                        const oldType = this.getDeviceType();
                        this.updateDeviceInfo();
                        const newType = this.getDeviceType();
                        
                        if (oldType !== newType) {
                            console.log(`📐 Device type changed: ${oldType} → ${newType}`);
                            this.updateBodyClasses();
                            this.logDeviceInfo();
                            this.reapplyLayout();
                        }
                    }, 100);
                });
                
                return this;
            },
            
            getDeviceType() {
                if (this.isMobile) return 'mobile';
                if (this.isTablet) return 'tablet';
                return 'desktop';
            },
            
            handleOrientationChange() {
                const oldType = this.getDeviceType();
                const oldWidth = window.innerWidth;
                const oldHeight = window.innerHeight;
                
                this.updateDeviceInfo();
                const newType = this.getDeviceType();
                
                console.log(`🔄 Orientation change complete:`);
                console.log(`   ${oldWidth}×${oldHeight} → ${window.innerWidth}×${window.innerHeight}`);
                console.log(`   ${oldType} → ${newType}`);
                
                // Always update classes and layout on orientation change
                this.updateBodyClasses();
                this.logDeviceInfo();
                this.reapplyLayout();
            },
            
            updateDeviceInfo() {
                this.userAgent = navigator.userAgent.toLowerCase();
                
                // Check for touch capability
                this.isTouchDevice = ('ontouchstart' in window) || 
                                     (navigator.maxTouchPoints > 0) || 
                                     (navigator.msMaxTouchPoints > 0);
                
                // Get current viewport dimensions
                const width = window.innerWidth;
                const height = window.innerHeight;
                
                // Reset flags
                this.isMobile = false;
                this.isTablet = false;
                this.isDesktop = false;
                
                // Device type detection
                const mobileRegex = /android|webos|iphone|ipod|blackberry|iemobile|opera mini/i;
                const tabletRegex = /ipad|android(?!.*mobile)|tablet/i;
                
                // Detect based on user agent AND viewport width
                if (mobileRegex.test(this.userAgent) || (this.isTouchDevice && width < 768)) {
                    this.isMobile = true;
                } else if (tabletRegex.test(this.userAgent) || (this.isTouchDevice && width >= 768 && width < 1024)) {
                    this.isTablet = true;
                } else {
                    this.isDesktop = true;
                }
            },
            
            updateBodyClasses() {
                // Remove all device classes
                document.body.classList.remove('device-mobile', 'device-tablet', 'device-desktop', 'touch-device');
                
                // Add current device classes
                if (this.isMobile) document.body.classList.add('device-mobile');
                if (this.isTablet) document.body.classList.add('device-tablet');
                if (this.isDesktop) document.body.classList.add('device-desktop');
                if (this.isTouchDevice) document.body.classList.add('touch-device');
            },
            
            reapplyLayout() {
                // Force container to recalculate width
                const container = document.querySelector('.container');
                if (container) {
                    // Trigger reflow
                    container.style.display = 'none';
                    void container.offsetHeight; // Force reflow
                    container.style.display = '';
                }
                
                // If there's an image displayed, re-apply its sizing
                const annotatedImage = document.getElementById('annotatedImage');
                if (annotatedImage && annotatedImage.src && annotatedImage.src.startsWith('data:')) {
                    const imageContainer = document.getElementById('imageContainer');
                    
                    // Re-apply device-specific image sizing
                    if (this.isMobile) {
                        imageContainer.style.width = '100%';
                        imageContainer.style.maxWidth = '100%';
                        annotatedImage.style.width = '100%';
                        console.log('📱 Re-applied mobile image sizing');
                    } else if (this.isTablet) {
                        imageContainer.style.maxWidth = '90vw';
                        imageContainer.style.width = '90vw';
                        annotatedImage.style.width = '100%';
                        console.log('📱 Re-applied tablet image sizing');
                    } else {
                        imageContainer.style.maxWidth = '100%';
                        imageContainer.style.width = '100%';
                        annotatedImage.style.width = '100%';
                        console.log('🖥️ Re-applied desktop image sizing');
                    }
                }
                
                console.log('✅ Layout reapplied');
            },
            
            logDeviceInfo() {
                const orientation = window.innerWidth > window.innerHeight ? 'landscape 🌄' : 'portrait 📱';
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('📱 Device Detection:');
                console.log(`   Type: ${this.getDeviceType().toUpperCase()}`);
                console.log(`   Touch: ${this.isTouchDevice ? 'Yes' : 'No'}`);
                console.log(`   Viewport: ${window.innerWidth}×${window.innerHeight}`);
                console.log(`   Orientation: ${orientation}`);
                console.log(`   User Agent: ${this.userAgent.substring(0, 50)}...`);
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            },
            
            // Helper methods
            shouldUseSimplifiedUI() {
                return this.isMobile;
            },
            
            shouldAutoExpandResults() {
                return this.isDesktop;
            },
            
            getOptimalImageQuality() {
                if (this.isMobile) return 'medium';
                if (this.isTablet) return 'high';
                return 'max';
            }
        };
        
        // Initialize device detection on load
        const device = DeviceDetector.init();
        
        // Updated API URL detection for integrated deployment
        const API_BASE_URL = (() => {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            
            // When opening HTML file directly (file:// protocol)
            if (protocol === 'file:') {
                return 'http://localhost:8000';
            }
            
            // When served from same origin (integrated deployment)
            return window.location.origin;
        })();
        
        console.log('Detected protocol:', window.location.protocol);
        console.log('Using API Base URL:', API_BASE_URL);
        
        // Test connection on page load with better error handling
        window.addEventListener('load', async function() {
            const textarea = document.getElementById('searchPhrases');
            
            // Pre-populate with test data
            textarea.value = '';

            textarea.placeholder = 'Enter search phrases separated by commas. Example: Tom Clancy, Nora Roberts, Stephen King, War and Peace, etc.';

            // Quick test shortcut: typing "ddd" auto-fills test phrases
            textarea.addEventListener('input', function(e) {
                if (this.value.toLowerCase() === 'ddd') {
                    this.value = 'Lee Child, Homecoming, homegoing, tom clancy, circle of three';
                }
            });

            // Device-specific adjustments
            if (device.isMobile) {
                console.log('📱 Mobile device detected - applying optimizations');
                // Simpler placeholder for mobile
                textarea.placeholder = 'Enter phrases, separated by commas';
            }
            
            // Test API connection
            console.log('Testing API connection...');
            const isConnected = await testConnection();
            
            if (!isConnected) {
                showError(`API not available at ${API_BASE_URL}. Start the service with: ./start_web_service.sh`);
            }
        });
        
        // Add connection test function
        async function testConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`, {
                    method: 'GET',
                    timeout: 5000
                });
                if (response.ok) {
                    console.log('✅ API connection successful');
                    return true;
                } else {
                    console.warn('⚠️ API responded with error:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('❌ API connection failed:', error);
                showError(`Cannot connect to API at ${API_BASE_URL}. Please ensure the service is running.`);
                return false;
            }
        }
        
        // Update threshold value display
        document.getElementById('threshold').addEventListener('input', function() {
            document.getElementById('thresholdValue').textContent = this.value + '%';
        });
        
        // UI Text Scale Control - Direct percentage-based scaling
        const uiTextScalePercentToSize = {
            50: '8px',
            75: '12px',
            100: '16px',
            125: '20px',
            150: '24px',
            175: '28px',
            200: '32px',
            250: '40px',
            300: '48px'
        };
        
        // Track sync state
        let textScalesLinked = false;
        
        // Set default annotation text scale - same for all devices (boost applied on submit)
        const defaultAnnotationScale = '100';
        
        // Force reset to defaults (remove these lines after first load if you want persistence)
        localStorage.setItem('uiTextScale', '100');
        localStorage.setItem('textScale', defaultAnnotationScale);
        
        // Load saved preferences or use defaults
        const savedUiTextScale = localStorage.getItem('uiTextScale') || '100';
        const savedTextScale = localStorage.getItem('textScale') || defaultAnnotationScale;
        const savedSyncState = localStorage.getItem('textScalesLinked') === 'true';
        
        document.getElementById('uiTextScale').value = savedUiTextScale;
        document.getElementById('textScale').value = savedTextScale;
        textScalesLinked = savedSyncState;
        
        applyUiTextScale(savedUiTextScale);
        updateSyncButton();
        
        document.getElementById('uiTextScale').addEventListener('change', function() {
            const scaleValue = this.value;
            applyUiTextScale(scaleValue);
            localStorage.setItem('uiTextScale', scaleValue);
            
            // If linked, update annotation scale and trigger reanalyze
            if (textScalesLinked) {
                document.getElementById('textScale').value = scaleValue;
                localStorage.setItem('textScale', scaleValue);
                autoReanalyze();
            }
        });
        
        document.getElementById('textScale').addEventListener('change', function() {
            const scaleValue = this.value;
            localStorage.setItem('textScale', scaleValue);
            
            // If linked, update page scale
            if (textScalesLinked) {
                document.getElementById('uiTextScale').value = scaleValue;
                applyUiTextScale(scaleValue);
                localStorage.setItem('uiTextScale', scaleValue);
            }
            
            // Always trigger reanalyze when annotation text size changes
            autoReanalyze();
        });
        
        // Sync button functionality
        document.getElementById('syncTextScales').addEventListener('click', function() {
            textScalesLinked = !textScalesLinked;
            localStorage.setItem('textScalesLinked', textScalesLinked);
            updateSyncButton();
            
            // If enabling sync, match the scales immediately
            if (textScalesLinked) {
                const uiScale = document.getElementById('uiTextScale').value;
                document.getElementById('textScale').value = uiScale;
                localStorage.setItem('textScale', uiScale);
            }
        });
        
        function applyUiTextScale(scaleValue) {
            // Remove all scale classes
            document.body.classList.remove(
                'text-scale-50', 'text-scale-75', 'text-scale-100',
                'text-scale-125', 'text-scale-150', 'text-scale-175',
                'text-scale-200', 'text-scale-250', 'text-scale-300'
            );
            
            // Add new scale class - this only affects .container font-size
            document.body.classList.add(`text-scale-${scaleValue}`);
            
            // CRITICAL: Never touch html or body font-size - always stays 16px
            // This prevents any viewport zoom changes
            
            // No more desktop panel switching - always single column
            
            console.log(`📏 UI text scale: ${scaleValue}% (viewport locked at 100%)`);
            
            // Force layout recalculation without triggering zoom
            void document.body.offsetHeight;
        }
        
        function updateSyncButton() {
            const btn = document.getElementById('syncTextScales');
            if (textScalesLinked) {
                btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                btn.style.color = 'white';
                btn.style.borderColor = '#5a67d8';
                btn.title = 'Font sizes synced (click to unlink)';
            } else {
                btn.style.background = 'white';
                btn.style.color = '#333';
                btn.style.borderColor = '#e2e8f0';
                btn.title = 'Sync font sizes';
            }
        }
        
        // Auto-reanalyze function
        function autoReanalyze() {
            const imageFile = document.getElementById('imageFile').files[0];
            const searchPhrasesText = document.getElementById('searchPhrases').value;
            
            // Only auto-submit if we have both image and phrases
            if (imageFile && searchPhrasesText.trim()) {
                console.log('🔄 Auto-reanalyzing with new annotation text size...');
                document.getElementById('ocrForm').dispatchEvent(new Event('submit'));
            }
        }
        
        document.getElementById('ocrForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const imageFile = document.getElementById('imageFile').files[0];
            const searchPhrasesText = document.getElementById('searchPhrases').value;
            const threshold = document.getElementById('threshold').value;
            let textScale = document.getElementById('textScale').value;  // Get text scale value
            
            // Boost annotation text size for mobile devices - 4.0x multiplier
            if (device.isMobile || device.isTablet) {
                const scaleInt = parseInt(textScale);
                // Multiply by 4.0 for mobile/tablet so 100% becomes 400%
                textScale = Math.round(scaleInt * 4.0).toString();
                console.log(`📱 Mobile boost: annotation text scale ${document.getElementById('textScale').value}% → ${textScale}%`);
            }

            if (!imageFile) {
                showError('Please select an image file');
                return;
            }
            
            if (!searchPhrasesText.trim()) {
                showError('Please enter search phrases');
                return;
            }
            
            // Parse search phrases
            const searchPhrases = searchPhrasesText.split(',').map(phrase => phrase.trim()).filter(phrase => phrase);
            
            if (searchPhrases.length === 0) {
                showError('Please enter at least one search phrase');
                return;
            }
            
            // Show loading state
            showLoading(true);
            hideError();
            hideResults();
            
            try {
                // Prepare form data
                formData.append('file', imageFile);
                formData.append('search_phrases', JSON.stringify(searchPhrases));
                formData.append('threshold', threshold);
                formData.append('text_scale', textScale);  // Add boosted text scale to form data
                
                const response = await fetch(`${API_BASE_URL}/upload-and-detect`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayResults(result, searchPhrases);
                } else {
                    showError(result.error_message || 'An error occurred while processing the image');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showError('Failed to connect to the API. Make sure the service is running on ' + API_BASE_URL);
            } finally {
                showLoading(false);
            }
        });
        
        function showLoading(show) {
            const loading = document.getElementById('loading');
            const submitBtn = document.getElementById('submitBtn');
            
            if (show) {
                loading.style.display = 'block';
                submitBtn.disabled = true;
                submitBtn.textContent = '⏳ Processing...';
            } else {
                loading.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.textContent = '🚀 Analyze Image';
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('error').style.display = 'none';
        }
        
        function hideResults() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('noResults').style.display = 'block';
        }
        
        function displayResults(result, searchPhrases) {
            const resultsSummary = document.getElementById('resultsSummary');
            const matchesList = document.getElementById('matchesList');
            
            // Show results section
            document.getElementById('results').style.display = 'block';
            document.getElementById('noResults').style.display = 'none';
            
            // Update summary with explainability metrics
            const avgConfidence = calculateAverageConfidence(result.matches);
            
            resultsSummary.innerHTML = `
                <h3>✅ Analysis Complete</h3>
                <div>
                    <span class="stat">📊 Total: ${result.total_matches}</span>
                    <span class="stat">⏱️ ${Math.round(result.processing_time_ms)}ms</span>
                    <span class="stat">🎯 Avg Confidence: ${avgConfidence}%</span>
                </div>
            `;
            
            // Update matches list with explainability emphasis
            if (result.total_matches > 0) {
                let matchesHTML = '<h3>🎯 Found Matches</h3>';
                
                // Device-specific instructions
                if (device.isMobile) {
                    matchesHTML += '<p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">💡 Tap "Why?" for match details</p>';
                } else {
                    matchesHTML += '<p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">💡 Click "Why?" to understand how each match was found</p>';
                }
                
                for (const [phrase, matches] of Object.entries(result.matches)) {
                    const matchId = phrase.replace(/\s+/g, '-').toLowerCase();
                    
                    // All matches collapsed by default - no auto-expand
                    
                    matchesHTML += `
                        <div class="match-item">
                            <div class="match-phrase">
                                <span>"${phrase}"</span>
                                <div>
                                    <span class="match-count">${matches.length}</span>
                                    <span class="toggle-details" onclick="toggleMatchDetails('${matchId}')">
                                        <span id="toggle-${matchId}">expand ▼</span>
                                    </span>
                                </div>
                            </div>
                            <div id="details-${matchId}" class="collapsible-content">
                                ${matches.map((match, idx) => {
                                    const confidenceLevel = match.explanation?.confidence_level || 'Medium';
                                    const confidenceClass = `confidence-${confidenceLevel.toLowerCase().replace(' ', '-')}`;
                                    
                                    // Extract relevant portion of text that contains the phrase
                                    const relevantText = extractRelevantText(match.text, phrase);
                                    
                                    return `
                                        <div class="match-details">
                                            <div class="match-header">
                                                <div class="match-text-preview" title="${match.text}">
                                                    "${relevantText}"
                                                </div>
                                                <div class="match-scores">
                                                    <span class="confidence-badge ${confidenceClass}">
                                                        ${confidenceLevel}
                                                    </span>
                                                    <span class="match-score">${Math.round(match.score)}%</span>
                                                    ${match.angle !== 0 ? `<span style="font-size: 0.9em;">🔄 ${Math.round(match.angle)}°</span>` : ''}
                                                    <span class="toggle-explanation" onclick="toggleExplanation('${matchId}-${idx}')">
                                                        <span id="toggle-exp-${matchId}-${idx}">Why? 🔍</span>
                                                    </span>
                                                </div>
                                            </div>
                                            ${match.explanation ? renderExplanation(match.explanation, `${matchId}-${idx}`) : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
                
                matchesList.innerHTML = matchesHTML;
            } else {
                matchesList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        😔 No matches found<br>
                        <small>Try adjusting the threshold or checking your search terms</small>
                    </div>
                `;
            }
            
            // Update annotated image
            if (result.annotated_image_base64) {
                const annotatedImage = document.getElementById('annotatedImage');
                const imageContainer = document.getElementById('imageContainer');
                
                // Create temp image to get actual dimensions for logging
                const tempImg = new Image();
                tempImg.onload = function() {
                    console.log(`🖼️ Received image: ${tempImg.width}×${tempImg.height}`);
                    console.log(`📱 Device: ${device.isMobile ? 'Mobile' : device.isTablet ? 'Tablet' : 'Desktop'}`);
                    
                    // Mobile: Force 96vw display
                    if (device.isMobile) {
                        console.log(`📱 Mobile: Image stays within card bounds`);
                        
                        // Clear any positioning that would break out of card
                        imageContainer.style.position = 'relative';
                        imageContainer.style.width = '100%';
                        imageContainer.style.maxWidth = '100%';
                        imageContainer.style.marginTop = '15px';
                        imageContainer.style.marginBottom = '0';
                        imageContainer.style.marginLeft = '0';
                        imageContainer.style.marginRight = '0';
                        imageContainer.style.left = '0';
                        
                        // Ensure image fills container
                        annotatedImage.style.width = '100%';
                        annotatedImage.style.height = 'auto';
                        annotatedImage.style.display = 'block';
                    } else if (device.isTablet) {
                        imageContainer.style.maxWidth = '90vw';
                        imageContainer.style.width = '90vw';
                        imageContainer.style.margin = '15px auto 0 auto';
                        annotatedImage.style.width = '100%';
                        annotatedImage.style.height = 'auto';
                        console.log(`📱 Tablet: Image sized to 90vw`);
                    } else {
                        // Desktop: Use card width
                        imageContainer.style.maxWidth = '100%';
                        imageContainer.style.width = '100%';
                        imageContainer.style.margin = '15px 0 0 0';
                        imageContainer.style.marginLeft = '0';
                        imageContainer.style.marginRight = '0';
                        annotatedImage.style.width = '100%';
                        annotatedImage.style.height = 'auto';
                        annotatedImage.style.marginLeft = '0';
                        annotatedImage.style.marginRight = '0';
                        console.log(`🖥️ Desktop: Image sized to card width`);
                    }
                    
                    // Add returned image size to summary
                    const summaryDiv = resultsSummary.querySelector('div');
                    const existingStat = summaryDiv.querySelector('.stat-returned');
                    if (existingStat) {
                        existingStat.textContent = `📐 ${tempImg.width}×${tempImg.height}`;
                    } else {
                        const returnedStat = document.createElement('span');
                        returnedStat.className = 'stat stat-returned';
                        returnedStat.textContent = `📐 ${tempImg.width}×${tempImg.height}`;
                        // Insert after Total and Time, before Avg Confidence
                        const stats = summaryDiv.querySelectorAll('.stat');
                        if (stats.length >= 2) {
                            stats[1].insertAdjacentElement('afterend', returnedStat);
                        } else {
                            summaryDiv.appendChild(returnedStat);
                        }
                    }
                    
                    // Log final display size after DOM update
                    setTimeout(() => {
                        const displayedWidth = annotatedImage.offsetWidth;
                        const displayedHeight = annotatedImage.offsetHeight;
                        const containerWidth = imageContainer.offsetWidth;
                        const viewportWidth = window.innerWidth;
                        console.log(`📺 Viewport: ${viewportWidth}px`);
                        console.log(`📦 Container: ${containerWidth}px (${(containerWidth / viewportWidth * 100).toFixed(1)}% of viewport)`);
                        console.log(`🖼️ Image displayed: ${displayedWidth}×${displayedHeight}`);
                    }, 100);
                };
                tempImg.src = `data:image/jpeg;base64,${result.annotated_image_base64}`;
                
                if (!imageZoom) {
                    imageZoom = new ImageZoom(annotatedImage, imageContainer);
                }
                
                imageZoom.setImage(`data:image/jpeg;base64,${result.annotated_image_base64}`);
                annotatedImage.style.display = 'block';
            }
        }
        
        function extractRelevantText(fullText, searchPhrase) {
            /**
             * Extract the most relevant portion of text that contains the search phrase.
             * Returns a smart excerpt showing the matched phrase in context.
             */
            
            // Normalize both for case-insensitive matching
            const normalizedText = fullText.toLowerCase();
            const normalizedPhrase = searchPhrase.toLowerCase();
            
            // Try to find the phrase in the text
            const phraseIndex = normalizedText.indexOf(normalizedPhrase);
            
            if (phraseIndex !== -1) {
                // Found exact substring - extract with context
                const maxLength = 50;
                const contextBefore = 10;
                const contextAfter = 10;
                
                const start = Math.max(0, phraseIndex - contextBefore);
                const end = Math.min(fullText.length, phraseIndex + normalizedPhrase.length + contextAfter);
                
                let excerpt = fullText.substring(start, end);
                
                // Add ellipsis if truncated
                if (start > 0) excerpt = '...' + excerpt;
                if (end < fullText.length) excerpt = excerpt + '...';
                
                return excerpt;
            }
            
            // If no exact match, try to find individual words from the phrase
            const phraseWords = normalizedPhrase.split(/\s+/).filter(w => w.length > 2);
            
            for (const word of phraseWords) {
                const wordIndex = normalizedText.indexOf(word);
                if (wordIndex !== -1) {
                    const maxLength = 50;
                    const contextBefore = 15;
                    const contextAfter = 15;
                    
                    const start = Math.max(0, wordIndex - contextBefore);
                    const end = Math.min(fullText.length, wordIndex + word.length + contextAfter);
                    
                    let excerpt = fullText.substring(start, end);
                    
                    if (start > 0) excerpt = '...' + excerpt;
                    if (end < fullText.length) excerpt = excerpt + '...';
                    
                    return excerpt;
                }
            }
            
            // Fallback: just show beginning of text with ellipsis
            const maxLength = 50;
            if (fullText.length <= maxLength) {
                return fullText;
            }
            
            return fullText.substring(0, maxLength - 3) + '...';
        }
        
        function calculateAverageConfidence(matches) {
            let total = 0;
            let count = 0;
            
            for (const phraseMatches of Object.values(matches)) {
                for (const match of phraseMatches) {
                    total += match.score;
                    count++;
                }
            }
            
            return count > 0 ? Math.round(total / count) : 0;
        }
        
        function renderExplanation(explanation, id) {
            if (!explanation) return '';
            
            const confidenceClass = `confidence-${explanation.confidence_level.toLowerCase().replace(' ', '-')}`;
            
            return `
                <div id="explain-${id}" class="explanation-panel" style="display: none; margin-top: 12px;">
                    <div style="margin-bottom: 12px; padding: 10px; background: #f0f4ff; border-radius: 6px;">
                        <div style="font-size: 0.95em; font-weight: 600; color: #2d3748; margin-bottom: 6px;">
                            ✨ ${explanation.confidence_level} Confidence Match
                        </div>
                        <div style="font-style: italic; color: #4a5568; font-size: 0.9em;">
                            💡 ${explanation.recommendation}
                        </div>
                    </div>
                    
                    <div style="margin-top: 12px;">
                        <div style="font-weight: 600; color: #2d3748; margin-bottom: 8px; font-size: 0.95em;">
                            🔍 How we matched this:
                        </div>
                        <ul class="factor-list">
                            ${explanation.reasoning.map(reason => `
                                <li class="factor-item" style="padding: 4px 0;">
                                    <span style="color: #48bb78;">✓</span> ${reason}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    
                    ${Object.keys(explanation.confidence_factors).length > 0 ? `
                        <div style="margin-top: 12px; padding: 10px; background: #f7fafc; border-radius: 6px;">
                            <div style="font-weight: 600; color: #2d3748; margin-bottom: 8px; font-size: 0.9em;">
                                📊 Confidence Breakdown:
                            </div>
                            <div style="display: grid; gap: 6px;">
                                ${Object.entries(explanation.confidence_factors).map(([factor, value]) => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0;">
                                        <span style="color: #4a5568; font-size: 0.85em;">${formatFactorName(factor)}</span>
                                        <span style="font-weight: 600; color: #5a67d8; font-size: 0.9em;">
                                            ${typeof value === 'number' ? value + '%' : value}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${explanation.warnings.length > 0 ? `
                        <div style="margin-top: 12px;">
                            ${explanation.warnings.map(warning => `
                                <div class="warning-badge" style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1.2em;">⚠️</span>
                                    <span>${warning}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        function formatFactorName(factor) {
            return factor
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
        }
        
        function toggleExplanation(id) {
            const panel = document.getElementById(`explain-${id}`);
            const toggle = document.getElementById(`toggle-exp-${id}`);
            
            if (panel) {
                if (panel.style.display === 'none') {
                    panel.style.display = 'block';
                    if (toggle) toggle.textContent = 'Hide 🔼';
                } else {
                    panel.style.display = 'none';
                    if (toggle) toggle.textContent = 'Why? 🔍';
                }
            }
        }

        // Toggle match details
        function toggleMatchDetails(matchId) {
            const details = document.getElementById(`details-${matchId}`);
            const toggle = document.getElementById(`toggle-${matchId}`);
            
            if (details.style.maxHeight && details.style.maxHeight !== '0px') {
                details.style.maxHeight = '0px';
                details.style.padding = '0 15px';
                toggle.textContent = 'details ▼';
            } else {
                details.style.maxHeight = '500px';
                details.style.padding = '15px';
                toggle.textContent = 'hide ▲';
            }
        }

        // Add collapsible functionality
        function toggleCollapsible(header) {
            const collapsible = header.parentElement;
            collapsible.classList.toggle('open');
        }

        // Handle file input change to show preview information
        document.getElementById('imageFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                const fileType = file.type.split('/')[1].toUpperCase();
                
                // Update help text with file information
                document.querySelector('.help-text').innerHTML = `
                    Supported formats: JPG, PNG, GIF, BMP<br>
                    Selected file: ${file.name} (${fileSizeMB} MB, ${fileType})
                `;
            }
        });


        // Image zoom functionality using Panzoom library
        class ImageZoom {
            constructor(imageElement, containerElement) {
                this.image = imageElement;
                this.container = containerElement;
                this.panzoomInstance = null;
                this.imageLoaded = false;
        
                this.init();
            }
    
            init() {
                // Wait for image to load before initializing Panzoom
                this.image.addEventListener('load', () => {
                    this.imageLoaded = true;
                    this.initPanzoom();
                });
        
                // Setup zoom control buttons
                document.getElementById('zoomInBtn').addEventListener('click', () => this.zoomIn());
                document.getElementById('zoomOutBtn').addEventListener('click', () => this.zoomOut());
                document.getElementById('resetZoomBtn').addEventListener('click', () => this.resetZoom());
        
                // Prevent context menu
                this.image.addEventListener('contextmenu', (e) => e.preventDefault());
        
                // If image is already loaded (e.g., from cache)
                if (this.image.complete && this.image.naturalWidth > 0) {
                    this.imageLoaded = true;
                    this.initPanzoom();
                }
            }
    
            initPanzoom() {
                // Destroy existing instance if any
                if (this.panzoomInstance) {
                    this.panzoomInstance.destroy();
                }
        
                // Initialize Panzoom with configuration
                this.panzoomInstance = Panzoom(this.image, {
                    maxScale: 5,           // Maximum zoom level
                    minScale: 1,           // Minimum zoom level (original size)
                    contain: 'outside',    // Allow panning beyond boundaries when zoomed
                    cursor: 'move',        // Cursor when panning
                    duration: 200,         // Animation duration in ms
                    easing: 'ease-in-out', // Animation easing
                    startScale: 1,         // Initial scale
                    startX: 0,             // Initial X position
                    startY: 0,             // Initial Y position
                    excludeClass: 'panzoom-exclude', // Elements with this class won't trigger pan
                    panOnlyWhenZoomed: true,         // Only allow panning when zoomed in
                    pinchAndPan: true,     // Enable pinch zoom and pan simultaneously
                    touchAction: 'auto'    // Browser touch handling
                });
        
                // Enable wheel/pinch zoom on the parent container
                const parent = this.image.parentElement;
                parent.addEventListener('wheel', (e) => {
                    if (!this.imageLoaded) return;
                    // Panzoom's zoomWithWheel automatically handles zoom to cursor position
                    this.panzoomInstance.zoomWithWheel(e);
                    this.updateUI();
                });
        
                // Listen for zoom/pan events to update UI
                this.image.addEventListener('panzoomchange', () => {
                    this.updateUI();
                });
        
                // Handle click to zoom in (only when not zoomed)
                this.image.addEventListener('click', (e) => {
                    if (!this.imageLoaded) return;
            
                    const scale = this.panzoomInstance.getScale();
                    if (scale === 1) {
                        // Zoom to 2x at the clicked point
                        this.panzoomInstance.zoomToPoint(2, { clientX: e.clientX, clientY: e.clientY });
                        this.updateUI();
                    }
                });
        
                // Initial UI update
                this.updateCursor();
                this.updateUI();
            }
    
            zoomIn() {
                if (!this.panzoomInstance) return;
                this.panzoomInstance.zoomIn();
                this.updateUI();
            }
    
            zoomOut() {
                if (!this.panzoomInstance) return;
                this.panzoomInstance.zoomOut();
                this.updateUI();
            }
    
            resetZoom() {
                if (!this.panzoomInstance) return;
                this.panzoomInstance.reset();
                this.updateUI();
            }
    
            updateCursor() {
                if (!this.panzoomInstance) return;
        
                const scale = this.panzoomInstance.getScale();
                if (scale > 1) {
                    this.image.style.cursor = 'grab';
                    this.image.classList.add('zoomed');
                    this.image.classList.remove('zoomable');
                } else {
                    this.image.style.cursor = 'zoom-in';
                    this.image.classList.remove('zoomed');
                    this.image.classList.add('zoomable');
                }
            }
    
            updateUI() {
                if (!this.panzoomInstance) return;
        
                const scale = this.panzoomInstance.getScale();
                const zoomControls = document.getElementById('zoomControls');
                const zoomInfo = document.getElementById('zoomInfo');
        
                // Show/hide zoom controls and info based on zoom level
                if (scale > 1.01) {
                    zoomControls.classList.add('visible');
                    zoomInfo.classList.add('visible');
                    zoomInfo.textContent = `${Math.round(scale * 100)}%`;
                } else {
                    zoomControls.classList.remove('visible');
                    zoomInfo.classList.remove('visible');
                }
        
                // Enable/disable zoom buttons based on scale limits
                const zoomInBtn = document.getElementById('zoomInBtn');
                const zoomOutBtn = document.getElementById('zoomOutBtn');
        
                zoomInBtn.disabled = scale >= 5;
                zoomOutBtn.disabled = scale <= 1;
        
                zoomInBtn.style.opacity = scale >= 5 ? '0.5' : '1';
                zoomOutBtn.style.opacity = scale <= 1 ? '0.5' : '1';
        
                // Update cursor
                this.updateCursor();
            }
    
            setImage(src) {
                this.imageLoaded = false;
                if (this.panzoomInstance) {
                    this.panzoomInstance.reset();
                }
                this.image.src = src;
            }
        }

        // Initialize zoom functionality
        let imageZoom = null;
        // Test connection on page load
        window.addEventListener('load', async function() {
            const isConnected = await testConnection();
            if (!isConnected) {
                showError(`API not available at ${API_BASE_URL}. Start the service with: ./start_web_service.sh`);
            }
        });
    </script>
</body>
</html>